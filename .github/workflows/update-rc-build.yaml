# This build will be triggered automatically when the adhoc build request is approved on Jira
# It will create a new RC pre-release tag based on the latest version tag in the repo
# This workflow increments the RC version by 1 (e.g., v1.2.0-rc.0 -> v1.2.0-rc.1)

name: Adhoc RC Build

on:
    workflow_dispatch:
        inputs:
            ref:
                description: 'Branch or ref to build from (defaults to main)' #  outer ref to see which branch has the build file
                required: false
                default: 'main'
                type: string
            jira_ticket:
                description: 'Jira ticket key'
                required: false
                type: string

jobs:
    update-adhoc-rc:
        runs-on: ubuntu-latest
        permissions:
            contents: write
        steps:
            - name: Checkout repository
              uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4.2.2
              with:
                  fetch-depth: 0
                  ref: ${{ inputs.ref || 'main' }} # inner ref to see which branch to checkout and build from

            - name: Generate new RC tag
              id: tag
              run: |
                  # Fetch all tags from remote
                  git fetch --tags

                  # Find the latest RC tag for current minor version
                  LATEST_RC_TAG=$(git tag -l "v*-rc.*" | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+-rc\.[0-9]+$' | sort -V | tail -n 1)

                  if [ -z "$LATEST_RC_TAG" ]; then
                      LATEST_RC_TAG="v1.1.0-rc.0"
                      echo "❌ No RC tags found. Starting from $LATEST_RC_TAG"
                  fi

                  echo "Latest RC tag: $LATEST_RC_TAG"

                  # Extract the version components
                  # Example: v1.2.0-rc.0 -> MAJOR=1, MINOR=2, PATCH=0, RC=0
                  VERSION_PART=$(echo $LATEST_RC_TAG | sed 's/^v//' | sed 's/-rc\..*//')
                  RC_PART=$(echo $LATEST_RC_TAG | sed 's/.*-rc\.//')

                  # Increment RC version
                  NEW_RC=$((RC_PART + 1))

                  # Create new RC tag
                  NEW_TAG="v${VERSION_PART}-rc.${NEW_RC}"

                  # Check if tag already exists
                  if git tag -l | grep -q "^${NEW_TAG}$"; then
                      echo "❌ Tag $NEW_TAG already exists."
                      exit 1
                  fi

                  echo "tag_name=${NEW_TAG}" >> $GITHUB_OUTPUT
                  echo "previous_rc=${LATEST_RC_TAG}" >> $GITHUB_OUTPUT
                  echo "✅ Will create new RC tag: ${NEW_TAG} (from ${LATEST_RC_TAG})"

            - name: Create GitHub RC Pre-Release
              uses: softprops/action-gh-release@da05d552573ad5aba039eaac05058a918a7bf631 # v2.2.2
              with:
                  tag_name: ${{ steps.tag.outputs.tag_name }}
                  name: ${{ steps.tag.outputs.tag_name }}
                  body: |
                      ${{ inputs.jira_ticket && format('Jira Ticket that triggered this build: {0}', inputs.jira_ticket) || '' }}

                      Previous RC: ${{ steps.tag.outputs.previous_rc }}
                      Build profile: Production

                      Released by: @${{ github.actor }}
                      Workflow: [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
                  generate_release_notes: true
                  prerelease: true
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
